
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "tutorials/pretrained_models.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_tutorials_pretrained_models.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_tutorials_pretrained_models.py:


Using pretrained models
=======================
This tutorial explains how to use pretrained models in TorchRL.

.. GENERATED FROM PYTHON SOURCE LINES 8-16

At the end of this tutorial, you will be capable of using pretrained models
for efficient image representation, and fine-tune them.

TorchRL provides pretrained models that are to be used either as transforms or as
components of the policy. As the sematic is the same, they can be used interchangeably
in one or the other context. In this tutorial, we will be using R3M (https://arxiv.org/abs/2203.12601),
but other models (e.g. VIP) will work equally well.


.. GENERATED FROM PYTHON SOURCE LINES 16-25

.. code-block:: default

    import torch.cuda
    from tensordict.nn import TensorDictSequential
    from torch import nn
    from torchrl.envs import R3MTransform, TransformedEnv
    from torchrl.envs.libs.gym import GymEnv
    from torchrl.modules import Actor

    device = "cuda:0" if torch.cuda.device_count() else "cpu"








.. GENERATED FROM PYTHON SOURCE LINES 26-30

Let us first create an environment. For the sake of simplicity, we will be using
a common gym environment. In practice, this will work in more challenging, embodied
AI contexts (e.g. have a look at our Habitat wrappers).


.. GENERATED FROM PYTHON SOURCE LINES 30-32

.. code-block:: default

    base_env = GymEnv("Ant-v4", from_pixels=True, device=device)








.. GENERATED FROM PYTHON SOURCE LINES 33-40

Let us fetch our pretrained model. We ask for the pretrained version of the model through the
download=True flag. By default this is turned off.
Next, we will append our transform to the environment. In practice, what will happen is that
each batch of data collected will go through the transform and be mapped on a "r3m_vec" entry
in the output tensordict. Our policy, consisting of a single layer MLP, will then read this vector and compute
the corresponding action.


.. GENERATED FROM PYTHON SOURCE LINES 40-47

.. code-block:: default

    r3m = R3MTransform("resnet50", in_keys=["pixels"], download=True).to(device)
    env_transformed = TransformedEnv(base_env, r3m)
    net = nn.Sequential(
        nn.LazyLinear(128), nn.Tanh(), nn.Linear(128, base_env.action_spec.shape[-1])
    )
    policy = Actor(net, in_keys=["r3m_vec"])





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Downloading: "https://pytorch.s3.amazonaws.com/models/rl/r3m/r3m_50.pt" to /github/home/.cache/torch/hub/checkpoints/r3m_50.pt
      0%|          | 0.00/374M [00:00<?, ?B/s]      0%|          | 272k/374M [00:00<02:29, 2.62MB/s]      0%|          | 664k/374M [00:00<01:56, 3.37MB/s]      0%|          | 1.23M/374M [00:00<01:26, 4.55MB/s]      1%|          | 1.99M/374M [00:00<01:07, 5.77MB/s]      1%|          | 2.81M/374M [00:00<00:58, 6.69MB/s]      1%|          | 3.64M/374M [00:00<00:53, 7.27MB/s]      1%|1         | 4.67M/374M [00:00<00:46, 8.27MB/s]      2%|1         | 5.88M/374M [00:00<00:40, 9.53MB/s]      2%|1         | 7.29M/374M [00:00<00:35, 11.0MB/s]      2%|2         | 8.87M/374M [00:01<00:30, 12.5MB/s]      3%|2         | 10.7M/374M [00:01<00:26, 14.3MB/s]      3%|3         | 12.7M/374M [00:01<00:23, 16.1MB/s]      4%|3         | 14.8M/374M [00:01<00:21, 17.8MB/s]      5%|4         | 17.0M/374M [00:01<00:19, 19.2MB/s]      5%|5         | 19.3M/374M [00:01<00:17, 20.9MB/s]      6%|5         | 21.8M/374M [00:01<00:16, 22.3MB/s]      6%|6         | 24.0M/374M [00:01<00:16, 21.9MB/s]      7%|6         | 26.1M/374M [00:01<00:16, 21.9MB/s]      8%|7         | 28.2M/374M [00:01<00:16, 21.9MB/s]      8%|8         | 30.5M/374M [00:02<00:16, 22.4MB/s]      9%|8         | 32.8M/374M [00:02<00:15, 23.0MB/s]      9%|9         | 35.2M/374M [00:02<00:15, 23.7MB/s]     10%|#         | 37.6M/374M [00:02<00:14, 23.6MB/s]     11%|#         | 40.0M/374M [00:02<00:14, 23.8MB/s]     11%|#1        | 42.6M/374M [00:02<00:14, 24.8MB/s]     12%|#2        | 45.3M/374M [00:02<00:13, 25.8MB/s]     13%|#2        | 48.2M/374M [00:02<00:12, 27.3MB/s]     14%|#3        | 51.2M/374M [00:02<00:11, 28.4MB/s]     14%|#4        | 54.2M/374M [00:02<00:11, 29.3MB/s]     15%|#5        | 57.0M/374M [00:03<00:11, 28.6MB/s]     16%|#5        | 59.7M/374M [00:03<00:13, 25.1MB/s]     17%|#6        | 62.2M/374M [00:03<00:13, 23.7MB/s]     17%|#7        | 64.5M/374M [00:03<00:14, 23.0MB/s]     18%|#7        | 67.0M/374M [00:03<00:13, 23.7MB/s]     19%|#8        | 69.5M/374M [00:03<00:13, 24.3MB/s]     19%|#9        | 72.0M/374M [00:03<00:12, 24.9MB/s]     20%|##        | 74.9M/374M [00:03<00:11, 26.3MB/s]     21%|##        | 77.9M/374M [00:03<00:11, 27.6MB/s]     22%|##1       | 80.7M/374M [00:04<00:10, 28.3MB/s]     22%|##2       | 83.7M/374M [00:04<00:10, 29.1MB/s]     23%|##3       | 86.7M/374M [00:04<00:10, 29.8MB/s]     24%|##3       | 89.8M/374M [00:04<00:09, 30.3MB/s]     25%|##4       | 93.3M/374M [00:04<00:09, 32.0MB/s]     26%|##5       | 96.7M/374M [00:04<00:08, 33.2MB/s]     27%|##6       | 100M/374M [00:04<00:08, 35.1MB/s]      28%|##7       | 104M/374M [00:04<00:07, 36.8MB/s]     29%|##8       | 108M/374M [00:04<00:07, 38.0MB/s]     30%|###       | 113M/374M [00:04<00:06, 39.9MB/s]     31%|###1      | 117M/374M [00:05<00:06, 40.3MB/s]     32%|###2      | 121M/374M [00:05<00:06, 42.1MB/s]     34%|###3      | 126M/374M [00:05<00:05, 44.6MB/s]     35%|###4      | 131M/374M [00:05<00:05, 46.6MB/s]     36%|###6      | 136M/374M [00:05<00:05, 48.3MB/s]     38%|###7      | 141M/374M [00:05<00:04, 49.5MB/s]     39%|###8      | 146M/374M [00:05<00:04, 50.1MB/s]     40%|####      | 151M/374M [00:05<00:04, 51.4MB/s]     42%|####1     | 157M/374M [00:05<00:04, 54.3MB/s]     43%|####3     | 163M/374M [00:05<00:03, 56.6MB/s]     45%|####5     | 169M/374M [00:06<00:03, 58.1MB/s]     47%|####6     | 175M/374M [00:06<00:03, 59.2MB/s]     48%|####8     | 181M/374M [00:06<00:03, 60.2MB/s]     50%|####9     | 187M/374M [00:06<00:03, 61.9MB/s]     52%|#####1    | 194M/374M [00:06<00:02, 64.9MB/s]     54%|#####3    | 201M/374M [00:06<00:02, 66.8MB/s]     55%|#####5    | 207M/374M [00:06<00:02, 68.1MB/s]     57%|#####7    | 214M/374M [00:06<00:02, 69.4MB/s]     59%|#####9    | 221M/374M [00:06<00:02, 57.7MB/s]     61%|######    | 227M/374M [00:07<00:02, 51.7MB/s]     62%|######2   | 232M/374M [00:07<00:03, 48.6MB/s]     63%|######3   | 237M/374M [00:07<00:03, 46.5MB/s]     65%|######4   | 242M/374M [00:07<00:03, 45.3MB/s]     66%|######5   | 246M/374M [00:07<00:02, 46.0MB/s]     67%|######7   | 251M/374M [00:07<00:02, 47.4MB/s]     68%|######8   | 256M/374M [00:07<00:02, 48.7MB/s]     70%|######9   | 261M/374M [00:07<00:02, 49.3MB/s]     71%|#######1  | 266M/374M [00:07<00:02, 50.0MB/s]     72%|#######2  | 271M/374M [00:08<00:02, 50.7MB/s]     74%|#######3  | 276M/374M [00:08<00:01, 52.8MB/s]     75%|#######5  | 282M/374M [00:08<00:01, 55.0MB/s]     77%|#######6  | 288M/374M [00:08<00:01, 57.0MB/s]     79%|#######8  | 294M/374M [00:08<00:01, 58.5MB/s]     80%|########  | 300M/374M [00:08<00:01, 59.4MB/s]     82%|########1 | 306M/374M [00:08<00:01, 60.5MB/s]     84%|########3 | 313M/374M [00:08<00:01, 63.6MB/s]     85%|########5 | 320M/374M [00:08<00:00, 66.0MB/s]     87%|########7 | 327M/374M [00:08<00:00, 67.9MB/s]     89%|########9 | 333M/374M [00:09<00:00, 69.1MB/s]     91%|######### | 340M/374M [00:09<00:00, 69.8MB/s]     93%|#########2| 347M/374M [00:09<00:00, 66.1MB/s]     95%|#########4| 355M/374M [00:09<00:00, 70.3MB/s]     97%|#########6| 363M/374M [00:09<00:00, 73.9MB/s]     99%|#########8| 370M/374M [00:09<00:00, 75.5MB/s]    100%|##########| 374M/374M [00:09<00:00, 40.6MB/s]




.. GENERATED FROM PYTHON SOURCE LINES 48-50

Let's check the number of parameters of the policy:


.. GENERATED FROM PYTHON SOURCE LINES 50-52

.. code-block:: default

    print("number of params:", len(list(policy.parameters())))





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    number of params: 4




.. GENERATED FROM PYTHON SOURCE LINES 53-55

We collect a rollout of 32 steps and print its output:


.. GENERATED FROM PYTHON SOURCE LINES 55-58

.. code-block:: default

    rollout = env_transformed.rollout(32, policy)
    print("rollout with transform:", rollout)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    rollout with transform: TensorDict(
        fields={
            action: Tensor(torch.Size([32, 8]), dtype=torch.float32),
            done: Tensor(torch.Size([32, 1]), dtype=torch.bool),
            next: TensorDict(
                fields={
                    r3m_vec: Tensor(torch.Size([32, 2048]), dtype=torch.float32)},
                batch_size=torch.Size([32]),
                device=cpu,
                is_shared=False),
            r3m_vec: Tensor(torch.Size([32, 2048]), dtype=torch.float32),
            reward: Tensor(torch.Size([32, 1]), dtype=torch.float32)},
        batch_size=torch.Size([32]),
        device=cpu,
        is_shared=False)




.. GENERATED FROM PYTHON SOURCE LINES 59-63

For fine tuning, we integrate the transform in the policy after making the parameters
trainable. In practice, it may be wiser to restrict this to a subset of the parameters (say the last layer
of the MLP).


.. GENERATED FROM PYTHON SOURCE LINES 63-67

.. code-block:: default

    r3m.train()
    policy = TensorDictSequential(r3m, policy)
    print("number of params after r3m is integrated:", len(list(policy.parameters())))





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    number of params after r3m is integrated: 163




.. GENERATED FROM PYTHON SOURCE LINES 68-72

Again, we collect a rollout with R3M. The structure of the output has changed slightly, as now
the environment returns pixels (and not an embedding). The embedding "r3m_vec" is an intermediate
result of our policy.


.. GENERATED FROM PYTHON SOURCE LINES 72-75

.. code-block:: default

    rollout = base_env.rollout(32, policy)
    print("rollout, fine tuning:", rollout)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    rollout, fine tuning: TensorDict(
        fields={
            action: Tensor(torch.Size([32, 8]), dtype=torch.float32),
            done: Tensor(torch.Size([32, 1]), dtype=torch.bool),
            next: TensorDict(
                fields={
                    pixels: Tensor(torch.Size([32, 480, 480, 3]), dtype=torch.uint8)},
                batch_size=torch.Size([32]),
                device=cpu,
                is_shared=False),
            r3m_vec: Tensor(torch.Size([32, 2048]), dtype=torch.float32),
            reward: Tensor(torch.Size([32, 1]), dtype=torch.float32)},
        batch_size=torch.Size([32]),
        device=cpu,
        is_shared=False)




.. GENERATED FROM PYTHON SOURCE LINES 76-80

The easyness with which we have swapped the transform from the env to the policy
is due to the fact that both behave like TensorDictModule: they have a set of `"in_keys"` and
`"out_keys"` that make it easy to read and write output in different context.



.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  19.894 seconds)


.. _sphx_glr_download_tutorials_pretrained_models.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example


    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: pretrained_models.py <pretrained_models.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: pretrained_models.ipynb <pretrained_models.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
